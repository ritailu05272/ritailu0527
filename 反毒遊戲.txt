import React, { useState, useEffect, useRef, useCallback } from 'react';
// ç§»é™¤ Lucide Icons, æ”¹ç”¨ Emoji

// --- è­‰ç‰©èˆ‡è¾¯è«–æ•¸æ“š (EVIDENCE_DB ä¿æŒä¸è®Š) ---

// è­‰ç‰©è³‡æ–™åº«
const EVIDENCE_DB = {
  coffee_seal: {
    id: 'coffee_seal',
    name: 'ç²—ç³™çš„å°å£ (æ¯’å’–å•¡)',
    desc: 'å’–å•¡åŒ…çš„å°å£å‘ˆç¾é‹¸é½’ç‹€ä¸”é•·çŸ­ä¸ä¸€ï¼Œæ˜é¡¯æ˜¯è¢«äººæ‹†é–‹å¾Œç”¨ç°¡æ˜“å°å£æ©Ÿé‡æ–°å°è£çš„ç—•è·¡ã€‚é€™é¡æ–°èˆˆæ¯’å“å¸¸å½è£æˆé›¶é£Ÿæˆ–é£²å“ã€‚',
    icon: 'â˜•',
    quiz: [
      {
        question: "ä¸‹åˆ—å“ªä¸€é …ã€ä¸æ˜¯ã€æ–°èˆˆæ¯’å“çš„å¸¸è¦‹ç‰¹å¾µï¼Ÿ",
        options: ["åŒ…è£å¸¸å½è£æˆå’–å•¡æˆ–å¥¶èŒ¶ç­‰é£²å“", "å¤šç‚ºæ··å’Œæ€§æ¯’å“ï¼Œæˆåˆ†è¤‡é›œ", "å¸¸è¢«èª¤èªç‚ºæ½®æµé›¶é£Ÿæˆ–æ´¾å°ç”¨è—¥", "å®ƒå€‘éƒ½æ˜¯ç´”å¤©ç„¶çš„æ¤ç‰©æˆåˆ†"],
        correctIndex: 3
      },
      {
        question: "é’å°‘å¹´å¸é£Ÿæ¯’å“å¾Œï¼Œæœ€ä¸»è¦çš„å‚·å®³æ˜¯ï¼Ÿ",
        options: ["å°è‡´è¼•å¾®è…¹ç€‰", "å¼•èµ·é•·æœŸä¾¿ç§˜", "åš´é‡æå®³å¤§è…¦ä¸­æ¨ç¥ç¶“ï¼Œå½±éŸ¿ç™¼è‚²èˆ‡è¨˜æ†¶", "é€ æˆçš®è†šä¹¾ç‡¥è„«çš®"],
        correctIndex: 2
      }
    ]
  },
  vape_shake: {
    id: 'vape_shake',
    name: 'ç•°å¸¸é¡«æŠ–çš„æ‰‹ (å–ªå±ç…™å½ˆ)',
    desc: 'å¸é£Ÿé›»å­ç…™çš„å­¸é•·æ‰‹éƒ¨å‡ºç¾ç„¡æ³•æ§åˆ¶çš„åŠ‡çƒˆé¡«æŠ–ã€‚é€™æ˜¯å—åˆ°ã€Œä¾æ‰˜å’ªé…¯ï¼ˆå–ªå±ç…™å½ˆï¼‰ã€å½±éŸ¿çš„ä¸­æ¯’ç—‡ç‹€ã€‚ä¾æ‰˜å’ªé…¯åœ¨é†«å­¸ä¸Šæ˜¯éº»é†‰åŠ‘ã€‚',
    icon: 'ğŸ§Ÿ',
    quiz: [
      {
        question: "ã€Œä¾æ‰˜å’ªé…¯ã€åœ¨é†«å­¸ä¸Šæœ€ä¸»è¦çš„ç”¨é€”æ˜¯ï¼Ÿ",
        options: ["æ­¢ç—›åŠ‘", "æŠ—ç”Ÿç´ ", "éº»é†‰/é®éœåŠ‘", "é™è¡€å£“è—¥"],
        correctIndex: 2
      },
      {
        question: "æ¿«ç”¨ä¾æ‰˜å’ªé…¯ï¼ˆå–ªå±ç…™å½ˆï¼‰æœ€å…¸å‹çš„å¤–è§€ç—‡ç‹€æ˜¯ï¼Ÿ",
        options: ["çš®è†šå¤§é¢ç©è®Šè‰²", "ç„¡æ³•æ§åˆ¶çš„è‚Œè‚‰åƒµç›´æˆ–åŠ‡çƒˆé¡«æŠ–",
                "è¦–åŠ›ç¬é–“å®Œå…¨å–ªå¤±", "é«”é‡åœ¨æ¥µçŸ­æ™‚é–“å…§æ€¥åŠ‡å¢åŠ "],
        correctIndex: 1
      }
    ]
  },
  candy_label: {
    id: 'candy_label',
    name: 'THC æ¨™ç¤º (å¤§éº»è»Ÿç³–)',
    desc: 'è»Ÿç³–åŒ…è£èƒŒé¢è§’è½å°æœ‰æ¥µå°çš„ã€ŒTHCã€åœ–æ¡ˆã€‚THCæ˜¯å››æ°«å¤§éº»é…šçš„ç¸®å¯«ï¼Œæ˜¯å¤§éº»ä¸­æœ€ä¸»è¦çš„ç²¾ç¥æ´»æ€§å’Œæˆç™®æˆåˆ†ï¼Œå±¬æ–¼äºŒç´šæ¯’å“ã€‚',
    icon: 'ğŸ¬',
    quiz: [
      {
        question: "å¤§éº» (Cannabis) åœ¨è‡ºç£æ¯’å“å±å®³é˜²åˆ¶æ¢ä¾‹ä¸­ï¼Œä¸»è¦è¢«æ­¸é¡ç‚ºç¬¬å¹¾ç´šæ¯’å“ï¼Ÿ",
        options: ["ç¬¬ä¸€ç´šæ¯’å“", "ç¬¬äºŒç´šæ¯’å“",
                "ç¬¬ä¸‰ç´šæ¯’å“", "ç¬¬å››ç´šæ¯’å“"],
        correctIndex: 1
      },
      {
        question: "å¤§éº»ä¸­ï¼Œæœƒè®“äººç”¢ç”Ÿèˆˆå¥®ã€å¹»è¦ºç­‰ç²¾ç¥ä½œç”¨çš„æˆåˆ†æ˜¯ï¼Ÿ",
        options: ["CBD (å¤§éº»äºŒé…š)", "CBN", "THC (å››æ°«å¤§éº»é…š)",
                "å¤§éº»ç´ æ²¹"],
        correctIndex: 2
      }
    ]
  },
  rainbow_filter: {
    id: 'rainbow_filter',
    name: 'å½©è‰²æ¿¾å˜´ (å½©è™¹è¸)',
    desc: 'é¦™è¸æ¿¾å˜´æ˜¯äº”é¡å…­è‰²çš„ï¼Œä¸”ç‡ƒç‡’æ™‚æœ‰ç‰¹æ®Šçš„å¡‘è† ç”œå‘³ã€‚é€™æ˜¯ã€Œå½©è™¹è¸ã€çš„ç‰¹å¾µï¼Œå¸¸æ··åˆKä»–å‘½ç­‰ä¸‰ç´šæ¯’å“ã€‚',
    icon: 'ğŸŒˆ',
    quiz: [
      {
        question: "å½©è™¹è¸ä¸­å¸¸æ‘»é›œKä»–å‘½ï¼ŒKä»–å‘½åœ¨è‡ºç£å±¬æ–¼ç¬¬å¹¾ç´šæ¯’å“ï¼Ÿ",
        options: ["ç¬¬ä¸€ç´šæ¯’å“", "ç¬¬äºŒç´šæ¯’å“", "ç¬¬ä¸‰ç´šæ¯’å“", "ç¬¬å››ç´šæ¯’å“"],
        correctIndex: 2
      },
      {
        question: "é•·æœŸæ¿«ç”¨Kä»–å‘½ (Kä»–å‘½) æœƒå°äººé«”é€ æˆæœ€åš´é‡çš„æå®³æ˜¯ï¼Ÿ",
        options: ["å¿ƒè‡Ÿè¡°ç«­", "è†€èƒ±åŠŸèƒ½åš´é‡å—æ (Kä»–å‘½è†€èƒ±)", "è‚è‡Ÿå¿«é€Ÿèç¸®", "èƒƒå‡ºè¡€"],
        correctIndex: 1
      }
    ]
  }
};

// --- éŠæˆ²åˆå§‹ç‹€æ…‹ ---

const INITIAL_STATS = {
  health: 100,    // ä¿¡å¿ƒ/å¥åº·
  sanity: 100,    // ç†æ™º (è§€å¯ŸéŒ¯èª¤æœƒæ‰£é™¤)
};

// --- éŠæˆ²å ´æ™¯èˆ‡é¸é … (å·²ç§»é™¤ quiz_fail_scene) ---

const SCENES = {
  start: {
    id: 'start',
    title: 'åºç« ï¼šKTV çš„é‚€ç´„',
    text: "ä½ æ˜¯åœ‹å°å…­å¹´ç´šå­¸ç”Ÿã€‚é€±äº”æ™šä¸Šï¼ŒåŒå­¸ã€Œé˜¿è±ªã€å …æŒè¦ä½ åƒåŠ ä¸€å€‹ã€Œæœ‰å¾ˆå¤šåœ‹ä¸­å­¸é•·å§ã€çš„æ…¶ç”Ÿæœƒã€‚ä½ å‹‰å¼·ç­”æ‡‰äº†ã€‚",
    bg: "bg-slate-900",
    options: [
      { text: "æ¨é–‹åŒ…å»‚çš„é–€", nextScene: 'investigation_hub' }
    ]
  },
  investigation_hub: {
    id: 'investigation_hub',
    title: 'èª¿æŸ¥ç’°ç¯€ï¼šè’è­‰',
    text: "åŒ…å»‚å…§çƒç…™ç˜´æ°£ã€‚ç‚ºäº†ä¿è­·è‡ªå·±ä¸¦æ­ç©¿ä»–å€‘çš„è¬Šè¨€ï¼Œä½ éœ€è¦ä»”ç´°è§€å¯Ÿç¾å ´ã€‚è«‹é¸æ“‡ä¸€å€‹å¯ç–‘è™•é€²è¡Œèª¿æŸ¥ã€‚\n\n(æ³¨æ„ï¼šäº‚è§€å¯Ÿæˆ–åšå‡ºå±éšªå˜—è©¦æœƒæ‰£é™¤ç†æ™ºå€¼ï¼Œç­”éŒ¯åæ¯’çŸ¥è­˜é¡Œä¹Ÿæœƒæ‰£ç†æ™º)",
    bg: "bg-indigo-950",
    type: 'hub', // ä½¿ç”¨ hub é¡å‹ä¾†ç¯©é¸é¸é …
    options: [
      // *** æ ¹æ“šä½¿ç”¨è€…è¦æ±‚æ›´æ–°é¸é …æªè¾­ç‚ºè§€å¯Ÿå°è±¡ ***
      // 1. è‡‰è‰²å¾ˆå·®çš„å­¸é•· (å°æ‡‰ VAPE/ä¾æ‰˜å’ªé…¯)
      { text: "è‡‰è‰²å¾ˆå·®çš„å­¸é•·", nextScene: 'sub_vape', condition: '!vape_shake' },
      // 2. åŒ…è£é®®è±”çš„è»Ÿç³– (å°æ‡‰ CANDY/å¤§éº»è»Ÿç³–)
      { text: "åŒ…è£é®®è±”çš„è»Ÿç³–", nextScene: 'sub_candy', condition: '!candy_label' },
      // 3. æ¡Œé¢ä¸Šçš„é£²æ–™ (å°æ‡‰ COFFEE/æ¯’å’–å•¡)
      { text: "æ¡Œé¢ä¸Šçš„é£²æ–™", nextScene: 'sub_coffee', condition: '!coffee_seal' },
      // 4. è§’è½æ•£è½çš„è¸è’‚ (å°æ‡‰ CIGARETTE/å½©è™¹è¸)
      { text: "è§’è½æ•£è½çš„è¸è’‚", nextScene: 'sub_cigarette', condition: '!rainbow_filter' },
      
      // æ”¤ç‰Œé¸é … (style: 'action' ä¸æœƒè¢«éš±è—)
      { text: "è­‰æ“šæ”¶é›†å®Œç•¢ï¼Œæº–å‚™æ”¤ç‰Œï¼", nextScene: 'pre_debate', style: 'action' }
    ]
  },

  // --- å­èª¿æŸ¥å ´æ™¯ (ä¿æŒä¸è®Š) ---
  sub_coffee: {
    id: 'sub_coffee',
    title: 'ç‰¹å¯«è§€å¯Ÿï¼šé£²å“åŒ…',
    text: "ä½ æ‹¿èµ·äº†å’–å•¡åŒ…ã€‚é€™çœ‹èµ·ä¾†åƒæ˜¯ä¸€å€‹çŸ¥åçš„å‹•æ¼«è¯åæ¬¾å’–å•¡ã€‚ä½ è¦æª¢æŸ¥å“ªè£¡ï¼Ÿ",
    bg: "bg-slate-800",
    options: [
      { text: "æª¢æŸ¥åŒ…è£æ­£é¢çš„åœ–æ¡ˆ", nextScene: 'sub_coffee_logo' },
      { text: "æª¢æŸ¥åŒ…è£çš„ã€Œå°å£è™•ã€", nextScene: 'sub_coffee_seal' },
      { text: "ç›´æ¥æ‰“é–‹ä¾†å–å–çœ‹", nextScene: 'sub_coffee_drink', effect: { health: -30, sanity: -20 } },
      { text: "æ”¾å›æ¡Œä¸Š (è¿”å›)", nextScene: 'investigation_hub' }
    ]
  },
  sub_coffee_logo: {
    id: 'sub_coffee_logo',
    title: 'è§€å¯Ÿçµæœ',
    text: "åœ–æ¡ˆå°åˆ·å¾—å¾ˆç²¾ç¾ï¼Œçœ‹èµ·ä¾†è·Ÿè¶…å•†è³£çš„ä¸€æ¨¡ä¸€æ¨£ã€‚é€™ä¼¼ä¹ä¸æ˜¯åˆ¤æ–·çœŸå½çš„é—œéµã€‚",
    bg: "bg-slate-800",
    options: [{ text: "å†çœ‹çœ‹åˆ¥çš„åœ°æ–¹", nextScene: 'sub_coffee' }]
  },
  sub_coffee_seal: {
    id: 'sub_coffee_seal',
    title: 'ç™¼ç¾ç·šç´¢ï¼',
    text: "ä½ æ‘¸äº†æ‘¸å°å£ã€‚ä¸å°å‹ï¼åŸå» çš„å°å£æ‡‰è©²æ˜¯å¹³æ»‘çš„ï¼Œä½†é€™å€‹å°å£å‘ˆç¾ã€Œé‹¸é½’ç‹€ã€ï¼Œè€Œä¸”é•·çŸ­ä¸ä¸€ï¼Œé‚„æœ‰é‡è¤‡åŠ ç†±çš„ç—•è·¡ã€‚é€™æ˜¯è¢«é‡æ–°å°è£éçš„ï¼\n\n(è«‹å›ç­”åæ¯’çŸ¥è­˜é¡Œä»¥ç¢ºèªè­‰æ“šä¸¦æ”¶éŒ„)",
    bg: "bg-yellow-900",
    startQuizFor: "coffee_seal",
    options: [{ text: "é–‹å§‹çŸ¥è­˜å•ç­”", nextScene: 'investigation_hub' }]
  },
  sub_coffee_drink: {
    id: 'sub_coffee_drink',
    title: 'å±éšªè¡Œç‚ºï¼',
    text: "ä½ ç«Ÿç„¶æƒ³è©¦å–ï¼Ÿé‚„å¥½ä½ åªæ²¾äº†ä¸€é»é»é»ç²‰æœ«ï¼ŒèˆŒé ­ç«‹åˆ»æ„Ÿåˆ°ä¸€é™£éº»ç—ºå’Œå™å¿ƒã€‚ä½ çš„å¥åº·å’Œç†æ™ºå—åˆ°å½±éŸ¿äº†ï¼",
    bg: "bg-red-900",
    options: [{ text: "å’³å’³...å¤ªå±éšªäº†...", nextScene: 'investigation_hub' }]
  },
  sub_vape: {
    id: 'sub_vape',
    title: 'ç‰¹å¯«è§€å¯Ÿï¼šå¸é£Ÿè€…èˆ‡å·¥å…·',
    text: "å­¸é•·æ­£é™¶é†‰åœ°å¸è‘—é›»å­ç…™ã€‚ä½ è¦è§€å¯Ÿä»€éº¼éƒ¨ä½ï¼Ÿ",
    bg: "bg-slate-800",
    options: [
      { text: "è§€å¯Ÿå¸é£Ÿå·¥å…·çš„ä¸»æ©Ÿå“ç‰Œ", nextScene: 'sub_vape_device' },
      { text: "è§€å¯Ÿå­¸é•·æ‹¿å·¥å…·çš„ã€Œæ‰‹ã€", nextScene: 'sub_vape_hand' },
      { text: "è¿”å›", nextScene: 'investigation_hub' }
    ]
  },
  sub_vape_device: {
    id: 'sub_vape_device',
    title: 'è§€å¯Ÿçµæœ',
    text: "é€™åªæ˜¯ä¸€å€‹æ™®é€šçš„é€šç”¨å‹é›»å­ç…™ä¸»æ©Ÿï¼Œå¤–è§€ä¸Šçœ‹ä¸å‡ºç…™å½ˆè£¡é¢è£äº†ä»€éº¼ã€‚",
    bg: "bg-slate-800",
    options: [{ text: "å†çœ‹çœ‹åˆ¥çš„åœ°æ–¹", nextScene: 'sub_vape' }]
  },
  sub_vape_hand: {
    id: 'sub_vape_hand',
    title: 'ç™¼ç¾ç·šç´¢ï¼',
    text: "ä½ ç™¼ç¾å­¸é•·çš„æ‰‹æŒ‡æ­£åœ¨ä»¥ä¸€ç¨®æ¥µä¸è‡ªç„¶çš„é »ç‡ã€ŒåŠ‡çƒˆé¡«æŠ–ã€ï¼Œé€£å·¥å…·éƒ½å¿«æ‹¿ä¸ç©©äº†ã€‚é€™æ˜¯æ–½ç”¨ã€Œä¾æ‰˜å’ªé…¯ã€å¾Œçš„å…¸å‹ç¥ç¶“ç—‡ç‹€ï¼\n\n(è«‹å›ç­”åæ¯’çŸ¥è­˜é¡Œä»¥ç¢ºèªè­‰æ“šä¸¦æ”¶éŒ„)",
    bg: "bg-yellow-900",
    startQuizFor: "vape_shake",
    options: [{ text: "é–‹å§‹çŸ¥è­˜å•ç­”", nextScene: 'investigation_hub' }]
  },
  sub_cigarette: {
    id: 'sub_cigarette',
    title: 'ç‰¹å¯«è§€å¯Ÿï¼šè¸è’‚',
    text: "ç…™ç°ç¼¸è£¡æ”¾è‘—å¹¾æ ¹æŠ½å‰©çš„è¸è’‚ã€‚ä½ è¦æª¢æŸ¥å“ªè£¡ï¼Ÿ",
    bg: "bg-slate-800",
    options: [
      { text: "èèçœ‹ç‡ƒç‡’çš„å‘³é“", nextScene: 'sub_cigarette_smell' },
      { text: "è§€å¯Ÿè¸çš„ã€Œæ¿¾å˜´ã€éƒ¨åˆ†", nextScene: 'sub_cigarette_filter' },
      { text: "è¿”å›", nextScene: 'investigation_hub' }
    ]
  },
  sub_cigarette_smell: {
    id: 'sub_cigarette_smell',
    title: 'è§€å¯Ÿçµæœ',
    text: "ç©ºæ°£ä¸­ç€°æ¼«è‘—ä¸€è‚¡ç”œè†©çš„å¡‘è† å‘³ã€‚é€™å‘³é“å¾ˆæ€ªï¼Œä½†å…‰æ†‘å‘³é“å¾ˆé›£ç•¶ä½œéµè­‰è·Ÿå°æ–¹è¾¯è«–ã€‚",
    bg: "bg-slate-800",
    options: [{ text: "éœ€è¦æ›´å…·é«”çš„è¦–è¦ºè­‰æ“š", nextScene: 'sub_cigarette' }]
  },
  sub_cigarette_filter: {
    id: 'sub_cigarette_filter',
    title: 'ç™¼ç¾ç·šç´¢ï¼',
    text: "ä½ ä»”ç´°çœ‹æ¿¾å˜´ï¼Œç™¼ç¾å®ƒæ˜¯ã€Œäº”é¡å…­è‰²ã€çš„ã€‚é€™æ˜¯å…¸å‹çš„ã€Œå½©è™¹è¸ã€ï¼Œå°ˆé–€ç”¨ä¾†å¸å¼•å¹´è¼•äººï¼Œè£¡é¢é€šå¸¸æ··æœ‰Kä»–å‘½ã€‚\n\n(è«‹å›ç­”åæ¯’çŸ¥è­˜é¡Œä»¥ç¢ºèªè­‰æ“šä¸¦æ”¶éŒ„)",
    bg: "bg-yellow-900",
    startQuizFor: "rainbow_filter",
    options: [{ text: "é–‹å§‹çŸ¥è­˜å•ç­”", nextScene: 'investigation_hub' }]
  },
  sub_candy: {
    id: 'sub_candy',
    title: 'ç‰¹å¯«è§€å¯Ÿï¼šå£æœè£½å“',
    text: "é€™åŒ…è»Ÿç³–åŒ…è£è‰²å½©é®®è±”ï¼Œå…¨æ˜¯è‹±æ–‡å­—ã€‚çœ‹èµ·ä¾†å¾ˆåƒæ™®é€šçš„é€²å£é›¶é£Ÿã€‚",
    bg: "bg-slate-800",
    options: [
      { text: "æ‹¿ä¸€é¡†èµ·ä¾†åƒ", nextScene: 'sub_candy_eat', effect: { sanity: -50, health: -20 } },
      { text: "ä»”ç´°é–±è®€ã€ŒåŒ…è£èƒŒé¢è§’è½ã€", nextScene: 'sub_candy_label' },
      { text: "è¿”å›", nextScene: 'investigation_hub' }
    ]
  },
  sub_candy_eat: {
    id: 'sub_candy_eat',
    title: 'å±éšªè¡Œç‚ºï¼',
    text: "ä½ åƒäº†ä¸€é¡†ã€‚é›–ç„¶ç”œç”œçš„ï¼Œä½†éäº†ä¸€æœƒå…’ä½ é–‹å§‹è¦ºå¾—é ­æšˆç›®çœ©ï¼Œæ™‚é–“æ„Ÿè®Šæ…¢äº†...ä½ ä¸­æ¯’äº†ï¼",
    bg: "bg-red-900",
    options: [{ text: "åŠªåŠ›ä¿æŒæ¸…é†’...", nextScene: 'investigation_hub' }]
  },
  sub_candy_label: {
    id: 'sub_candy_label',
    title: 'ç™¼ç¾ç·šç´¢ï¼',
    text: "ä½ åœ¨å¯†å¯†éº»éº»çš„æˆåˆ†è¡¨è§’è½ï¼Œç™¼ç¾äº†ä¸€å€‹ä¸èµ·çœ¼çš„è­¦å‘Šåœ–ç¤ºï¼šã€THCã€(å››æ°«å¤§éº»é…š)ã€‚é€™æ˜¯äºŒç´šæ¯’å“å¤§éº»çš„æˆåˆ†ï¼\n\n(è«‹å›ç­”åæ¯’çŸ¥è­˜é¡Œä»¥ç¢ºèªè­‰æ“šä¸¦æ”¶éŒ„)",
    bg: "bg-yellow-900",
    startQuizFor: "candy_label",
    options: [{ text: "é–‹å§‹çŸ¥è­˜å•ç­”", nextScene: 'investigation_hub' }]
  },

  // --- å¾ŒçºŒå ´æ™¯ (ä¿æŒä¸è®Š) ---
  pre_debate: {
    id: 'pre_debate',
    title: 'æ­£é¢å°æ±º',
    text: "ä½ ç«™èµ·ä¾†å¤§è²èªªï¼šã€Œæˆ‘è¦å›å®¶äº†ï¼Œé€™è£¡çš„æ±è¥¿éƒ½æœ‰å•é¡Œï¼ã€\n\nè—¥é ­å¤§å“¥æ“‹åœ¨é–€å£ï¼šã€Œè­‰æ“šåœ¨å“ªè£¡ï¼Ÿæ‹¿ä¸å‡ºä¾†å°±åˆ¥æƒ³èµ°ã€‚ã€\n\n(æ•™å­¸ï¼šå°æ‰‹æœƒèªªå‡ºä¸€é€£ä¸²è­‰è©ã€‚è«‹ä»”ç´°é–±è®€ï¼Œå°å¯ç–‘çš„èªå¥é€²è¡Œã€Œè¿½å•ã€ä»¥é€¼å‡ºç ´ç¶»ï¼Œæœ€å¾Œåœ¨é—œéµè­‰è©ä¸Šã€Œå‡ºç¤ºã€è­‰ç‰©ï¼)",
    bg: "bg-red-900",
    options: [
      // ä¿®æ­£: ç§»é™¤ nextScene: 'debate_start'ï¼Œå› ç‚º 'action: 'start_debate'' æœƒç›´æ¥è™•ç†ç‹€æ…‹åˆ‡æ›
      { text: "é–‹å§‹è¾¯è«–ï¼(æ¶ˆè€—ä¿¡å¿ƒå€¼)", action: 'start_debate' } 
    ]
  },
  good_end: {
    id: 'good_end',
    title: 'çµå±€ï¼šé€†è½‰è£åˆ¤',
    text: "ã€Œå—š...ï¼ã€é¢å°ä½ æŒ‡å‡ºçš„æ¯ä¸€å€‹ç ´ç¶»ï¼Œä»–å€‘ç„¡å¾æŠµè³´ã€‚ä½ çš„é‚è¼¯åƒåˆ©åˆƒä¸€æ¨£åˆ‡é–‹äº†ä»–å€‘çš„è¬Šè¨€ç¶²ã€‚\n\né€™æ™‚è­¦å¯Ÿè¡äº†é€²ä¾†ã€‚åŸä¾†ä½ æ‹–å»¶çš„æ™‚é–“å‰›å¥½è®“å·¡é‚éšŠå¯Ÿè¦ºç•°ç‹€ã€‚ä½ æ†‘è—‰è‘—å†·éœçš„è§€å¯Ÿèˆ‡é‚è¼¯ï¼ŒæˆåŠŸä¿è­·äº†è‡ªå·±ï¼",
    type: 'win',
    bg: "bg-blue-800"
  },
  bad_end_debate: {
    id: 'bad_end_debate',
    title: 'çµå±€ï¼šè¾¯è«–å¤±æ•—',
    text: "ä½ é›–ç„¶è¦ºå¾—ä¸å°å‹ï¼Œä½†ç„¡æ³•å…·é«”æŒ‡å‡ºå“ªè£¡æœ‰å•é¡Œã€‚ã€Œçœ‹å§ï¼Œå°æœ‹å‹å°±æ˜¯æ„›äº‚è¬›è©±ã€‚ã€\n\nä½ è¢«ä»–å€‘çš„æ°£å‹¢å£“å€’ï¼Œæœ€å¾Œåœ¨åŠå¼·è¿«ä¸‹æ¥è§¸äº†é‚£äº›æ±è¥¿...",
    type: 'lose',
    bg: "bg-black"
  },
  bad_end_run: {
    id: 'bad_end_run',
    title: 'çµå±€ï¼šèº«å¿ƒå´©æ½°',
    text: "ä½ çš„å¥åº·æˆ–ç†æ™ºå€¼å·²é™åˆ°å±éšªæ°´å¹³ã€‚ä½ å¤±å»äº†åˆ¤æ–·åŠ›ï¼Œç„¡æ³•æœ‰æ•ˆä¿è­·è‡ªå·±ï¼Œæœ€çµ‚å°è‡´äº†ä¸å¯æŒ½å›çš„å¾Œæœã€‚", // çµ±ä¸€è™•ç†æ‰€æœ‰å¥åº·/ç†æ™ºæ­¸é›¶çš„å¤±æ•—
    type: 'neutral',
    bg: "bg-gray-800"
  },
  // åˆªé™¤ quiz_fail_scene
};


// --- å…ƒä»¶ï¼šè­‰ç‰©å¡ (å¯é»æ“Š) ---
const EvidenceCard = ({ itemId, onClick }) => {
  const item = EVIDENCE_DB[itemId];
  return (
    <button
        onClick={() => onClick(itemId)}
        className="pixel-button-small bg-slate-800 p-3 flex items-center gap-3 transition-transform hover:scale-[1.02] hover:bg-slate-700 text-left w-full"
    >
      <div className="text-2xl">{item.icon}</div>
      <div>
        <div className="font-bold text-yellow-400 text-sm flex items-center gap-2">{item.name} <span className='text-yellow-500'>ğŸ‘ï¸</span></div>
        <div className="text-xs text-gray-300 hidden md:block">{item.desc.substring(0, 20)}... (é»æ“ŠæŸ¥çœ‹è©³æƒ…)</div>
      </div>
    </button>
  );
};


// --- å…ƒä»¶ï¼šæ¨¡æ…‹è¦–çª—åŸºåº• ---
const ModalBase = ({ title, children, onClose }) => (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-4 animate-fade-in">
        <div className="bg-slate-900 w-full max-w-lg pixel-box border-4 border-blue-500 shadow-pixel-blue p-6 relative animate-zoom-in">
            <h3 className="text-2xl font-black text-blue-400 mb-4 border-b border-slate-700 pb-2 flex items-center gap-2">
                {title}
            </h3>
            {children}
            <button
                onClick={onClose}
                className="absolute top-4 right-4 text-gray-400 hover:text-white transition"
            >
                <span className="text-2xl">âŒ</span>
            </button>
        </div>
    </div>
);

// --- å…ƒä»¶ï¼šçŸ¥è­˜å•ç­”æ¨¡æ…‹è¦–çª— ---
const QuizModal = ({ itemId, onQuizComplete, stats, setStats }) => {
    const item = EVIDENCE_DB[itemId];
    const quizData = item.quiz;

    const [currentQuestion, setCurrentQuestion] = useState(0);
    const [selectedOption, setSelectedOption] = useState(null);
    const [isCorrect, setIsCorrect] = useState(null); // null, true, false
    const [feedbackMessage, setFeedbackMessage] = useState('');

    // è™•ç†é¸é …é¸æ“‡
    const handleSelectOption = (index) => {
        if (isCorrect !== null) return; // å·²ç¶“å›ç­”éäº†
        setSelectedOption(index);
    };

    // è™•ç†æäº¤ç­”æ¡ˆ
    const handleSubmitAnswer = () => {
        if (selectedOption === null) {
            setFeedbackMessage("è«‹å…ˆé¸æ“‡ä¸€å€‹ç­”æ¡ˆï¼");
            return;
        }

        const currentQuiz = quizData[currentQuestion];
        const correct = selectedOption === currentQuiz.correctIndex;
        setIsCorrect(correct);

        if (correct) {
            setFeedbackMessage("âœ… æ­å–œä½ ï¼ç­”æ¡ˆæ­£ç¢ºã€‚");
            // ç­”å°ï¼Œç¹¼çºŒä¸‹ä¸€é¡Œæˆ–å®Œæˆ
            if (currentQuestion < quizData.length - 1) {
                setTimeout(() => {
                    setCurrentQuestion(prev => prev + 1);
                    setSelectedOption(null);
                    setIsCorrect(null);
                    setFeedbackMessage('');
                }, 1000);
            } else {
                // å…©é¡Œéƒ½ç­”å°
                setTimeout(() => onQuizComplete(true, itemId), 1500);
            }
        } else {
            // ç­”éŒ¯ï¼Œæ‡²ç½°ä¸¦çµæŸ (åƒ…é—œé–‰ Modal, å›åˆ°èª¿æŸ¥ä¸­å¿ƒ)
            setFeedbackMessage(`âŒ ç­”éŒ¯äº†ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${currentQuiz.options[currentQuiz.correctIndex]} (ç†æ™º -15)`);
            setStats(prev => ({
                ...prev,
                sanity: Math.max(0, prev.sanity - 15) // ç­”éŒ¯æ‰£ç†æ™º
            }));

            // ç„¡è«–å¦‚ä½•ï¼Œç­”éŒ¯ç•¶å‰å›åˆçµæŸï¼Œåˆ¤å®šå¤±æ•—
            setTimeout(() => onQuizComplete(false, itemId), 3000);
        }
    };

    const currentQuiz = quizData[currentQuestion];
    const optionStyle = (index) => {
        const base = "pixel-button-option p-3 text-left transition-all border ";
        if (isCorrect === null) {
            return base + (selectedOption === index
                ? "bg-blue-600 border-blue-400 hover:bg-blue-700"
                : "bg-slate-700 border-slate-600 hover:bg-slate-600");
        } else {
            if (index === currentQuiz.correctIndex) {
                return base + "bg-green-700 border-green-500 text-white font-bold animate-pulse";
            }
            if (index === selectedOption) {
                return base + "bg-red-700 border-red-500 text-white font-bold";
            }
            return base + "bg-slate-700 border-slate-600 opacity-50";
        }
    };

    return (
        <ModalBase title={<><span className='text-2xl'>â“</span> çŸ¥è­˜å•ç­” ({currentQuestion + 1}/{quizData.length})</>} onClose={() => onQuizComplete(false, itemId)}>
            <div className="text-gray-200 mb-4 font-bold text-lg leading-relaxed">
                {currentQuiz.question}
            </div>
            <div className="space-y-3 mb-6">
                {currentQuiz.options.map((option, index) => (
                    <button
                        key={index}
                        onClick={() => handleSelectOption(index)}
                        disabled={isCorrect !== null}
                        className={optionStyle(index) + " w-full"}
                    >
                        <span className="font-mono text-yellow-300 mr-2">{String.fromCharCode(65 + index)}.</span> {option}
                    </button>
                ))}
            </div>

            <div className="min-h-[30px] mb-4 text-center">
                {feedbackMessage && (
                    <p className={`font-bold ${isCorrect ? 'text-green-400' : 'text-red-400'} animate-fade-in`}>
                        {feedbackMessage}
                    </p>
                )}
            </div>

            <button
                onClick={handleSubmitAnswer}
                disabled={selectedOption === null || isCorrect !== null}
                className="pixel-button w-full py-3 bg-yellow-600 hover:bg-yellow-700 text-white font-bold disabled:opacity-50 transition-transform shadow-lg"
            >
                {isCorrect !== null ? (isCorrect ? 'ç¹¼çºŒ/å®Œæˆ' : 'ç¢ºèªçµæœ') : 'æäº¤ç­”æ¡ˆ'}
            </button>
            <p className="text-sm text-gray-400 text-center mt-3">
                * è‹¥ç­”éŒ¯ï¼Œå°‡æ‰£é™¤ 15 é»ç†æ™ºå€¼ã€‚
            </p>
        </ModalBase>
    );
};

// --- å…ƒä»¶ï¼šè­‰ç‰©è©³æƒ…æ¨¡æ…‹è¦–çª— ---
const EvidenceDetailModal = ({ itemId, onClose }) => {
    const item = EVIDENCE_DB[itemId];
    if (!item) return null;

    return (
        <ModalBase title={<><span className='text-2xl'>ğŸ’¡</span> è­‰ç‰©è©³æƒ…ï¼š{item.name}</>} onClose={onClose}>
            <div className="flex items-start gap-4 mb-4">
                <div className="text-5xl">{item.icon}</div>
                <div className="text-gray-200 text-sm">
                    {item.desc}
                </div>
            </div>

            <p className="text-sm text-yellow-300 font-bold mt-4">åæ¯’çŸ¥è­˜å°æé†’ (ä¾†æºï¼šåæ¯’å±•ç¤ºæ•™è‚²è³‡æºç¶²)</p>
            <ul className="list-disc list-inside text-gray-400 text-xs ml-4 space-y-1">
                {item.quiz.map((q, index) => (
                    <li key={index}>
                        <span className="font-semibold text-gray-300">Q{index + 1}:</span> {q.question}
                    </li>
                ))}
            </ul>
        </ModalBase>
    );
};

// --- å…ƒä»¶ï¼šè¾¯è«–ä»‹é¢ (å·²ä¿®æ”¹) ---
const DebateInterface = ({ currentRoundIndex, hp, onPresent, evidenceList, onGiveUp, setStats }) => { // å¢åŠ  setStats æ¥æ”¶
  // è¾¯è«–è…³æœ¬ (ä¿æŒä¸è®Š)
  const DEBATE_SCRIPT = [
    {
      id: 1,
      speaker: "è—¥é ­å¤§å“¥",
      statements: [
        { text: "å–‚ï¼ä½ èªªé€™å’–å•¡æœ‰å•é¡Œï¼Ÿç¬‘æ­»äººã€‚", type: "normal" },
        { text: "é€™å¯æ˜¯åç‰Œå’–å•¡åŒ…æ¬¸ï¼ä½ çœ‹é€™åŒ…è£é¡è‰²å¤šæ¼‚äº®ï¼Œå“ªè£¡æœ‰å‡ï¼Ÿ", type: "normal" },
        {
          text: "é€™åŒ…è£è·Ÿè¶…å•†è³£çš„ä¸€æ¨¡ä¸€æ¨£ï¼Œå®Œå…¨æ²’æœ‰è¢«æ‹†éçš„ç—•è·¡ã€‚", // åˆå§‹è¬Šè¨€
          type: "critical",
          pressedText: "å˜–...å°±ç®—å°å£æœ‰é»çšºçšºçš„ï¼Œé‚£ä¹Ÿæ˜¯é‹é€æ™‚å£“åˆ°çš„ï¼åæ­£ã€å°å£ã€çµ•å°æ˜¯åŸå» æ©Ÿå™¨å£“çš„ï¼",
          weakness: "coffee_seal"
        },
        { text: "å°å­©å­ä¸æ‡‚å°±ä¸è¦äº‚è¬›è©±ï¼Œå¿«å–äº†å®ƒã€‚", type: "normal" }
      ],
      counterText: "æˆ‘æœ‰ç•°è­°ï¼ä½ èªªå°å£æ˜¯åŸå» çš„ï¼Ÿè«‹çœ‹é€™å€‹ï¼åŸå» å°å£æ˜¯å¹³æ•´çš„ï¼Œä½†é€™å€‹å‘ˆç¾ã€Œé‹¸é½’ç‹€ã€ï¼Œæ˜é¡¯æ˜¯è¢«æ‹†é–‹å¾Œé‡æ–°å°è£çš„ï¼",
      failText: "åŒ…è£é¡è‰²ç¢ºå¯¦æ²’å•é¡Œ...é€™å¥è©±ä¼¼ä¹æ²’æœ‰ç ´ç¶»ã€‚(è©¦è‘—åˆ‡æ›åˆ°å…¶ä»–è­‰è©ï¼Œæˆ–å°å¯ç–‘çš„åœ°æ–¹é€²è¡Œã€Œè¿½å•ã€)"
    },
    {
      id: 2,
      speaker: "æŸ“é«®å­¸é•·",
      statements: [
        { text: "å¹¹å˜›ä¸€ç›´ç›¯è‘—æˆ‘çœ‹ï¼Ÿæˆ‘åªæ˜¯æŠ½å€‹æ°´æœç…™æ”¾é¬†ä¸€ä¸‹ã€‚", type: "normal" },
        { text: "é€™é›»å­ç…™å¾ˆæ™®é€šå•Šï¼Œåˆ°è™•éƒ½è²·å¾—åˆ°ï¼Œå°±æ˜¯åŠ äº†é»è–„è·ã€‚", type: "normal" },
        {
          text: "è€Œä¸”æˆ‘ä¹Ÿæ²’æœ‰è¦ºå¾—å“ªè£¡ä¸èˆ’æœï¼Œæˆ‘å¾ˆæ­£å¸¸ã€‚",
          type: "critical",
          pressedText: "æ‰‹æŠ–ï¼Ÿå–”...é€™...é€™åªæ˜¯å†·æ°£å¤ªå¼·ç¨å¾®ç™¼æŠ–è€Œå·²ï¼ä½ çœ‹ï¼Œæˆ‘å¾ˆç©©ï¼Œå®Œå…¨æ²’æœ‰ç¥ç¶“ä¸­æ¯’ï¼",
          weakness: "vape_shake"
        }
      ],
      counterText: "æˆ‘æœ‰ç•°è­°ï¼å†·æ°£å¤ªå¼·ï¼Ÿå¤§å®¶çš„çœ¼ç›æ˜¯é›ªäº®çš„ï¼ä½ çš„æ‰‹æ­£åœ¨ã€ŒåŠ‡çƒˆé¡«æŠ–ã€ï¼Œé€£ç…™éƒ½å¿«æ‹¿ä¸ä½äº†ï¼Œé€™æ˜¯ä¾æ‰˜å’ªé…¯ä¸­æ¯’çš„å…¸å‹ç—‡ç‹€ï¼",
      failText: "ä»–èªªé›»å­ç…™å¾ˆæ™®é€š...å¥½åƒä¹Ÿæ²’éŒ¯ï¼Ÿæ‰¾ä¸åˆ°åˆ‡å…¥é»ã€‚(è©¦è‘—å°‹æ‰¾ä»–èº«é«”ç‹€æ³çš„æè¿°é€²è¡Œã€Œè¿½å•ã€)"
    },
    {
      id: 3,
      speaker: "é˜¿è±ª (ä½ çš„æœ‹å‹)",
      statements: [
        { text: "å¥½å•¦...åˆ¥åµæ¶äº†ã€‚åƒé¡†ç³–æœæ¶ˆæ¶ˆæ°£ç¸½è¡Œäº†å§ï¼Ÿ", type: "normal" },
        { text: "é€™åŒ…è£å…¨æ˜¯è‹±æ–‡ï¼Œæ˜¯é€²å£çš„é«˜ç´šè»Ÿç³–å–”ã€‚", type: "normal" },
        {
          text: "æˆ‘å‰›å‰›çœ‹éæˆåˆ†è¡¨äº†ï¼Œå…¨éƒ½æ˜¯ç³–å’Œæœæ±ï¼Œçµ•å°æ²’å•é¡Œã€‚",
          type: "critical",
          pressedText: "é‚£å€‹å°åœ–æ¡ˆï¼Ÿé‚£å€‹...é‚£å€‹æ˜¯åœ‹å¤–çš„ã€Œç´ é£Ÿæ¨™ç« ã€å•¦ï¼åæ­£çµ•å°ä¸æ˜¯æ¯’å“æˆåˆ†ï¼",
          weakness: "candy_label"
        },
        { text: "ä½ çœ‹æˆ‘åƒäº†ä¹Ÿæ²’äº‹å•Šï¼Œå¾ˆå¥½åƒçš„ã€‚", type: "normal" }
      ],
      counterText: "æˆ‘æœ‰ç•°è­°ï¼ä½ èªªé€™æ˜¯ç´ é£Ÿæ¨™ç« ï¼Ÿé˜¿è±ªï¼Œä½ çœ‹æ¸…æ¥šï¼é€™å€‹è§’è½çš„ã€ŒTHCã€æ˜¯å››æ°«å¤§éº»é…šçš„ç¸®å¯«ï¼é€™æ˜¯æ¯’å“ï¼",
      failText: "æ™®é€šçš„é€²å£ç³–æœ...ç¢ºå¯¦æ²’å•é¡Œ...(æ˜¯ä¸æ˜¯æœ‰ä»€éº¼ç´°ç¯€è¢«å¿½ç•¥äº†ï¼Ÿè©¦è‘—è¿½å•é—œæ–¼æˆåˆ†çš„é‚£ä¸€å¥)"
    },
     { // ç¬¬å››å›åˆï¼šå½©è™¹è¸ï¼Œéœ€è¦æ‰€æœ‰è­‰æ“šéƒ½æ‰¾åˆ°
      id: 4,
      speaker: "è—¥é ­å¤§å“¥",
      statements: [
        { text: "å°‘åœ¨é‚£é‚Šçµ¦æˆ‘äº‚æ‰¯ï¼KTV è£¡æŠ½è¸å¾ˆæ­£å¸¸ï¼Œèª°ç®¡ä½ è¸è’‚é•·æ€æ¨£ï¼Ÿ", type: "normal" },
        {
          text: "å†èªªï¼Œä½ çœ‹åˆ°æ¡Œä¸Šé€™åŒ…è¸ï¼Œæ¿¾å˜´å°±æ˜¯é»ƒè‰²çš„ï¼Œè·Ÿæˆ‘æŠ½çš„å®Œå…¨ä¸€æ¨£ã€‚",
          type: "critical",
          pressedText: "ä½ èªªå½©è‰²ï¼Ÿé‚£æ˜¯ç‡ˆå…‰åå°„å•¦ï¼è§’è½é‚£å¹¾æ ¹è¸è’‚ï¼Œæˆ‘ä¿è­‰æ¿¾å˜´éƒ½æ˜¯æ™®é€šçš„ç™½è‰²ï¼",
          weakness: "rainbow_filter"
        },
        { text: "ä½ å·²ç¶“æ²’æœ‰ç‰Œå¯æ‰“äº†ï¼Œå¿«é»åŠ å…¥æˆ‘å€‘å§...", type: "normal" }
      ],
      counterText: "æˆ‘æœ‰ç•°è­°ï¼ä½ èªªæ¿¾å˜´æ˜¯æ™®é€šçš„ç™½è‰²ï¼Ÿè«‹çœ‹è§’è½çš„è¸è’‚ï¼å®ƒæ˜é¡¯æ˜¯ã€Œäº”é¡å…­è‰²ã€çš„ï¼Œé‚£æ˜¯æ–°å‹æ¯’å“ã€å½©è™¹è¸ã€çš„ç‰¹å¾µï¼",
      failText: "è¸è’‚ç¢ºå¯¦çœ‹èµ·ä¾†å¾ˆæ™®é€š...æˆ–è¨±ä½ éœ€è¦æ›´æº–ç¢ºåœ°æŒ‡å‡ºé¡è‰²ä¸Šçš„ç ´ç¶»ï¼"
    }
  ];
  const round = DEBATE_SCRIPT[currentRoundIndex];

  // ç‹€æ…‹
  const [stmtIndex, setStmtIndex] = useState(0);
  const [pressedMap, setPressedMap] = useState({});
  const [selectedEvidence, setSelectedEvidence] = useState(null);
  const [feedback, setFeedback] = useState(null);
  const [showObjection, setShowObjection] = useState(false);
  const [showHoldIt, setShowHoldIt] = useState(false);
  const [pressFeedbackText, setPressFeedbackText] = useState("");
  const [showHint, setShowHint] = useState(false); // æ–°å¢ï¼šæ§åˆ¶æç¤ºé¡¯ç¤ºçš„ç‹€æ…‹

  // é‡ç½®å›åˆç‹€æ…‹
  useEffect(() => {
    setStmtIndex(0);
    setPressedMap({});
    setSelectedEvidence(null);
    setFeedback(null);
    setShowHint(false); // é‡ç½®æç¤ºç‹€æ…‹
  }, [currentRoundIndex]);

  // åˆ‡æ›è­‰è¨€
  const handlePrev = () => setStmtIndex(prev => Math.max(0, prev - 1));
  const handleNext = () => setStmtIndex(prev => Math.min(round.statements.length - 1, prev + 1));

  // è™•ç†è¿½å• (Hold It!)
  const handlePress = () => {
    const currentStmt = round.statements[stmtIndex];

    setShowHoldIt(true);
    setTimeout(() => setShowHoldIt(false), 1000);

    // å¦‚æœæ˜¯é—œéµå¥
    if (currentStmt.type === 'critical') {
      setPressedMap(prev => ({ ...prev, [stmtIndex]: true }));
      setPressFeedbackText(currentStmt.pressedText);
      setFeedback('press_success');
    } else {
      // å»¢è©±
      setPressFeedbackText("å°æ‰‹å¾ˆä¸è€ç…©ï¼šã€Œé€™æœ‰ä»€éº¼å¥½å•çš„ï¼Ÿåˆ¥æ‰“æ–·æˆ‘èªªè©±ï¼ã€(ç†æ™º -5)");
      setStats(prev => ({ // ä½¿ç”¨å‚³å…¥çš„ setStats
                ...prev,
                sanity: Math.max(0, prev.sanity - 5) // äº‚è¿½å•æ‰£ç†æ™º
      }));
      setFeedback('press_fail');
      setShowHint(true); // è¿½å•éŒ¯èª¤å¾Œé¡¯ç¤ºæç¤º
    }

    setTimeout(() => setFeedback(null), 3000);
  };

  // è™•ç†å‡ºç¤º (Present)
  const handlePresent = () => {
    if (!selectedEvidence) return;

    const currentStmt = round.statements[stmtIndex];
    const isPressed = pressedMap[stmtIndex];

    // 1. æª¢æŸ¥æ˜¯å¦æ˜¯é—œéµè­‰è¨€ä¸”å°šæœªè¿½å•
    if (currentStmt.type === 'critical' && !isPressed) {
        // New: Failed to Press first
        setFeedback('needs_press');
        setSelectedEvidence(null); // æ¸…é™¤é¸æ“‡
        setShowHint(true); // å˜—è©¦å‡ºç¤ºä½†æœªè¿½å•ï¼Œé¡¯ç¤ºæç¤º
        setTimeout(() => setFeedback(null), 3000);
        return; // åœæ­¢å‹•ä½œ
    }


    // åˆ¤æ–·é‚è¼¯ï¼š
    // 1. å¿…é ˆæ˜¯ critical èªå¥
    // 2. å¿…é ˆå…ˆè¿½å•é (é¡¯ç¤ºå‡º true form) - å·²åœ¨ä¸Šæ–¹æª¢æŸ¥
    // 3. è­‰æ“šå¿…é ˆå°æ‡‰

    if (currentStmt.type === 'critical' && currentStmt.weakness === selectedEvidence && isPressed) {
       // æˆåŠŸ
       setShowObjection(true);
       setTimeout(() => {
         setShowObjection(false);
         setFeedback('success');
       }, 1500);
    } else {
       // å¤±æ•—
       setFeedback('fail');
       // å¤±æ•—æ‡²ç½°
       setTimeout(() => {
         setFeedback(null);
         onPresent(false);
       }, 2500);
    }
  };

  const handleNextRound = () => {
    setFeedback(null);
    setSelectedEvidence(null);
    onPresent(true);
  };

  // å‹•ç•«å±¤
  if (showObjection) {
    return (
      <div className="fixed inset-0 z-50 flex items-center justify-center bg-red-600/90 animate-pulse pointer-events-none">
         <div className="text-white font-black text-6xl md:text-9xl italic tracking-tighter transform -rotate-6 border-4 border-white p-4 pixel-text-shadow">
           æˆ‘æœ‰ç•°è­°ï¼
         </div>
      </div>
    );
  }
  if (showHoldIt) {
    return (
      <div className="fixed inset-0 z-50 flex items-center justify-center bg-blue-600/90 animate-pulse pointer-events-none">
         <div className="text-white font-black text-6xl md:text-9xl italic tracking-tighter transform -rotate-6 border-4 border-white p-4 pixel-text-shadow">
           ç­‰ä¸€ä¸‹ï¼
         </div>
      </div>
    );
  }

  const currentStatementData = round.statements[stmtIndex];
  const isCriticalAndNotPressed = currentStatementData.type === 'critical' && !pressedMap[stmtIndex];
  const isCriticalAndPressed = currentStatementData.type === 'critical' && pressedMap[stmtIndex];

  const displayText = isCriticalAndPressed
    ? currentStatementData.pressedText
    : currentStatementData.text;

  return (
    <div className="flex flex-col h-full relative">

      {/* å°æ‰‹è­‰è¨€å€ */}
      <div className="bg-red-950 p-6 pixel-box border-b-4 border-red-700 mb-4 relative transition-all duration-500 min-h-[160px] flex flex-col justify-center">
        <div className="absolute -top-3 left-4 bg-red-600 text-white px-3 py-1 text-sm font-bold border border-white shadow-pixel-white">
          <span>è­‰è¨€ ({currentRoundIndex + 1}-{stmtIndex + 1}/{round.statements.length})</span>
          {isCriticalAndPressed && (
             <span className="bg-yellow-500 text-black text-xs px-1 font-bold animate-pulse ml-2">ğŸ’¥ ç ´ç¶»å·²æ­éœ²</span>
          )}
          {isCriticalAndNotPressed && showHint && ( // å¢åŠ  showHint åˆ¤æ–·
             <span className="bg-blue-500 text-white text-xs px-1 font-bold animate-pulse-slow ml-2">â“ é—œéµè­‰è¨€ - éœ€è¿½å•</span> // New Hint
          )}
        </div>

        {/* å°èˆªæŒ‰éˆ• (å·¦å³ç®­é ­) - è®“ç©å®¶è‡ªç”±æŸ¥çœ‹è­‰è¨€ */}
        <div className="absolute top-1/2 -translate-y-1/2 left-1 md:left-2 z-10">
             <button onClick={handlePrev} disabled={stmtIndex === 0} className="p-3 bg-red-700/80 text-white hover:bg-red-600 disabled:opacity-40 border border-white/50 pixel-button-nav">
                â¬…ï¸
             </button>
        </div>
        <div className="absolute top-1/2 -translate-y-1/2 right-1 md:right-2 z-10">
             <button onClick={handleNext} disabled={stmtIndex === round.statements.length - 1} className="p-3 bg-red-700/80 text-white hover:bg-red-600 disabled:opacity-40 border border-white/50 pixel-button-nav">
                â¡ï¸
             </button>
        </div>

        {/* ä¿®æ”¹æ–‡å­—é¡è‰²é‚è¼¯ï¼šåªæœ‰åœ¨å·²æ­éœ²(Pressed)æˆ–é¡¯ç¤ºæç¤º(Hint)æ™‚æ‰è®Šè‰²ï¼Œå¦å‰‡ç¶­æŒç™½è‰²éš±è—ç‰¹å¾µ */}
        <div className={`text-xl font-bold leading-relaxed text-center px-8 ${
            isCriticalAndPressed 
                ? "text-yellow-200" 
                : (isCriticalAndNotPressed && showHint 
                    ? "text-yellow-300 animate-pulse-slow" 
                    : "text-white")
        }`}>
          "{displayText}"
        </div>
      </div>

      {/* è¿½å•åé¥‹æ°£æ³¡ (è‡¨æ™‚é¡¯ç¤º) */}
      {(feedback === 'press_success' || feedback === 'press_fail') && (
          <div className="absolute top-24 left-0 right-0 mx-auto w-3/4 bg-blue-800 text-white p-3 border border-blue-400 z-10 animate-fade-in text-center pixel-box-small">
              <div className="font-bold text-yellow-400 mb-1">{feedback === 'press_success' ? "ğŸ’¥ ç™¼ç¾çŸ›ç›¾ï¼" : "â“ è¿½å•çµæœ"}</div>
              {pressFeedbackText}
          </div>
      )}

      {/* ç©å®¶ç‹€æ…‹ */}
      <div className="flex justify-between items-center mb-2 px-2 border-b border-gray-700 pb-2">
        <div className="flex items-center gap-2">
          <span className="text-xl">ğŸ”¨</span>
          <span className="font-bold text-yellow-500 pixel-text-shadow">ä½ çš„å›åˆ</span>
        </div>
        <div className="flex items-center gap-2">
          <span className={hp < 30 ? "text-red-500 animate-pulse text-2xl" : "text-green-500 text-2xl"}>â¤ï¸</span>
          <span className="font-mono text-xl text-green-300 pixel-text-shadow">{hp}% ä¿¡å¿ƒ</span>
        </div>
      </div>

      {/* æ“ä½œå€ */}
      {/* --- Feedback States --- */}
      {feedback === 'success' ? (
        <div className="flex-1 bg-green-900/50 pixel-box-small border border-green-500 flex flex-col items-center justify-center animate-fade-in">
          <span className="text-4xl text-green-400 mb-4">âœ…</span>
          <p className="text-lg text-green-100 mb-6 text-center font-bold">{round.counterText}</p>
          <button onClick={handleNextRound} className="pixel-button bg-green-600 hover:bg-green-700 text-white px-8 py-3 font-bold flex items-center gap-2">
            ä¸‹ä¸€å›åˆ â¡ï¸
          </button>
        </div>
      ) : feedback === 'fail' ? (
        <div className="flex-1 bg-red-900/50 pixel-box-small border border-red-500 flex flex-col items-center justify-center animate-shake">
          <span className="text-4xl text-red-400 mb-4">âŒ</span>
          <p className="text-lg text-red-100 mb-2 font-bold">åé§å¤±æ•—ï¼</p>
          <p className="text-red-300 mb-2 text-center text-sm">
             {pressedMap[stmtIndex] && currentStatementData.type === 'critical'
                ? "é›–ç„¶ä½ æ‰¾åˆ°äº†ç ´ç¶»ï¼Œä½†å‡ºç¤ºçš„è­‰æ“šä¸å°ï¼"
                : "é€™å¥è©±çœ‹èµ·ä¾†æ²’æœ‰æ˜é¡¯çŸ›ç›¾ï¼Œæˆ–è€…ä½ éœ€è¦å…ˆã€Œè¿½å•ã€å‡ºç´°ç¯€..."}
          </p>
          <p className="text-sm text-red-400">-20 ä¿¡å¿ƒå€¼</p>
        </div>
      ) : feedback === 'needs_press' ? (
         // NEW: Needs Press Feedback
        <div className="flex-1 bg-blue-900/50 pixel-box-small border border-blue-500 flex flex-col items-center justify-center animate-fade-in">
          <span className="text-4xl text-blue-400 mb-4">ğŸ›‘</span>
          <p className="text-xl text-blue-100 mb-2 font-bold">éŒ¯èª¤æµç¨‹ï¼šå¿…é ˆå…ˆè¿½å•ï¼</p>
          <p className="text-blue-300 mb-2 text-center text-sm">
             é€™æ˜¯é—œéµè­‰è¨€ï¼Œä½ å¿…é ˆå…ˆç”¨ã€Œè¿½å• (Press)ã€ä¾†é€¼å°æ–¹èªªå‡ºçœŸæ­£çš„ç ´ç¶»ï¼Œæ‰èƒ½å‡ºç¤ºè­‰ç‰©ã€‚
          </p>
        </div>
      ) : (
        <div className="flex-1 flex flex-col">
          {/* è­‰ç‰©åˆ—è¡¨ */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-2 overflow-y-auto flex-1 mb-4 pr-2 max-h-[200px]">
            {evidenceList.length === 0 && (
              <div className="col-span-full text-center text-gray-500 py-8">
                ç³Ÿç³•ï¼ä½ æ²’æœ‰æ”¶é›†åˆ°ä»»ä½•è­‰ç‰©ï¼
              </div>
            )}
            {/* ä¿®æ­£ï¼šä½¿ç”¨ evidenceList è€Œé inventory */}
            {evidenceList.map(eId => { 
              const item = EVIDENCE_DB[eId];
              return (
                <div
                  key={eId}
                  onClick={() => setSelectedEvidence(eId)}
                  className={`p-3 text-left border cursor-pointer transition-all pixel-button-small ${
                    selectedEvidence === eId
                      ? 'bg-yellow-700 border-yellow-400 shadow-md scale-[1.02] border-2 shadow-pixel-yellow'
                      : 'bg-slate-800 border-slate-600 hover:bg-slate-700'
                  }`}
                >
                  <div className="flex items-center gap-2">
                    <span className="text-2xl">{item.icon}</span>
                    <div className="font-bold text-gray-100">{item.name}</div>
                  </div>
                </div>
              );
            })}
          </div>

          {/* æŒ‰éˆ•å€ */}
          <div className="flex gap-3 mt-auto">
            <button
                onClick={handlePress}
                className="pixel-button flex-1 py-3 font-bold text-white transition-colors flex items-center justify-center gap-1 bg-blue-600 hover:bg-blue-700 shadow-lg"
            >
               <span className='text-xl'>ğŸ—£ï¸</span> è¿½å• (Press)
            </button>

            <button
              onClick={handlePresent}
              disabled={!selectedEvidence && isCriticalAndNotPressed}
              className={`pixel-button flex-[1.5] py-3 font-bold text-white transition-colors flex items-center justify-center gap-1 ${
                selectedEvidence
                    ? "bg-yellow-600 hover:bg-yellow-700 shadow-lg border-yellow-800"
                    : "bg-slate-700 text-slate-500 border-slate-800 cursor-not-allowed"
              }`}
            >
               <span className='text-xl'>ğŸ‘ï¸</span>
               {isCriticalAndNotPressed && selectedEvidence ? 'âš ï¸ è¿½å•å„ªå…ˆ' : 'å‡ºç¤º (Present)'}
            </button>
          </div>
        </div>
      )}
    </div>
  );
};


// --- ä¸»ç¨‹å¼ ---

const App = () => {
  const [currentSceneId, setCurrentSceneId] = useState('start');
  const [inventory, setInventory] = useState([]);
  const [stats, setStats] = useState(INITIAL_STATS);

  const [isDebating, setIsDebating] = useState(false);
  const [debateRound, setDebateRound] = useState(0);

  // æ–°å¢ç‹€æ…‹
  const [isQuizOpen, setIsQuizOpen] = useState(false);
  const [currentQuizItem, setCurrentQuizItem] = useState(null); // ç•¶å‰æ­£åœ¨ä½œç­”çš„è­‰ç‰©ID
  const [isDetailOpen, setIsDetailOpen] = useState(false);
  const [detailItem, setDetailItem] = useState(null); // ç•¶å‰æ­£åœ¨æŸ¥çœ‹è©³æƒ…çš„è­‰ç‰©ID

  const scrollRef = useRef(null);
  const currentScene = SCENES[currentSceneId];

  // æª¢æŸ¥ç”Ÿå‘½å€¼å’Œç†æ™ºå€¼ (éŠæˆ²çµæŸæ¢ä»¶)
  useEffect(() => {
    // éŠæˆ²çµæŸæ¢ä»¶ï¼šå¥åº·æˆ–ç†æ™ºå€¼æ­¸é›¶
    if ((stats.health <= 0 || stats.sanity <= 0) && !currentSceneId.startsWith('bad_end')) {
        // å¦‚æœä¸åœ¨è¾¯è«–ä¸­ï¼Œå‰‡è½‰åˆ°ä¸€èˆ¬å¤±æ•—çµå±€
        if(!isDebating) {
             setCurrentSceneId('bad_end_run');
        }
        // å¦‚æœåœ¨è¾¯è«–ä¸­ï¼Œå‰‡ debate å¤±æ•—æœƒç¶“ç”± handleDebateResult è§¸ç™¼ bad_end_debate
    }
  }, [stats, currentSceneId, isDebating]);

  // å ´æ™¯æ²å‹•
  useEffect(() => {
    if (scrollRef.current) {
      scrollRef.current.scrollTop = 0;
    }
  }, [currentSceneId, isDebating]);

  // è™•ç†é¸é …é»æ“Š
  const handleOptionClick = useCallback((option) => {
    // è™•ç†ç†æ™º/å¥åº·è®ŠåŒ–
    if (option.effect) {
        setStats(prev => ({
            health: Math.min(100, Math.max(0, prev.health + (option.effect.health || 0))),
            sanity: Math.min(100, Math.max(0, prev.sanity + (option.effect.sanity || 0))),
        }));
    }

    // è™•ç†é–‹å§‹è¾¯è«–
    if (option.action === 'start_debate') {
      if (inventory.length === 0) {
          setCurrentSceneId('bad_end_run');
          return;
      }
      setIsDebating(true);
      setDebateRound(0);
      setStats(prev => ({ ...prev, health: 100 }));
      // ç”±æ–¼ isDebating è¨­ç‚º trueï¼Œæ¸²æŸ“æœƒè‡ªå‹•åˆ‡æ›åˆ° DebateInterfaceï¼Œ
      // æ‰€ä»¥ç„¡éœ€è¨­ç½® nextSceneIdï¼Œç›´æ¥ return å³å¯ã€‚
      return;
    }

    const nextSceneId = option.nextScene;
    const nextSceneObj = SCENES[nextSceneId];

    // è™•ç†è§¸ç™¼çŸ¥è­˜å•ç­”
    if (nextSceneObj && nextSceneObj.startQuizFor) {
        if (!inventory.includes(nextSceneObj.startQuizFor)) {
            setCurrentSceneId(nextSceneId);
            setCurrentQuizItem(nextSceneObj.startQuizFor);
            setIsQuizOpen(true);
            return;
        } else {
             // å¦‚æœå·²ç¶“æ‹¿åˆ°ï¼Œç›´æ¥è¿”å› hub
             setCurrentSceneId('investigation_hub');
             return;
        }
    }

    // æ­£å¸¸å ´æ™¯è·³è½‰
    setCurrentSceneId(nextSceneId);
  }, [inventory]);

  // è™•ç†çŸ¥è­˜å•ç­”çµæœ
  const handleQuizComplete = (success, itemId) => {
    setIsQuizOpen(false);
    setCurrentQuizItem(null);

    if (success) {
        // æˆåŠŸï¼šåŠ å…¥è­‰ç‰©ï¼Œé¡¯ç¤ºè©³æƒ…ï¼Œè¿”å› hub
        setInventory(prev => [...prev, itemId]);
        setDetailItem(itemId);
        setIsDetailOpen(true);
        setCurrentSceneId('investigation_hub');
    } else {
        // å¤±æ•—ï¼šåªæ‰£é™¤æ‡²ç½° (å·²åœ¨ QuizModal å…§è™•ç† sanity æ‰£é™¤)ï¼Œä¸¦è¿”å›èª¿æŸ¥ä¸­å¿ƒã€‚
        // å¦‚æœå¥åº·/ç†æ™ºå·²æ­¸é›¶ï¼ŒuseEffect æœƒè™•ç†éŠæˆ²çµæŸã€‚
        setCurrentSceneId('investigation_hub');
    }
  };

  // è™•ç†è¾¯è«–çµæœ
  const handleDebateResult = (success) => {
    if (success) {
      const nextRound = debateRound + 1;
      // å‡è¨­ DEBATE_SCRIPT é•·åº¦ç‚º 4 (round 0, 1, 2, 3)
      if (nextRound >= 4) {
        setIsDebating(false);
        setCurrentSceneId('good_end');
      } else {
        setDebateRound(nextRound);
      }
    } else {
      const newHealth = stats.health - 20;
      setStats(prev => ({ ...prev, health: newHealth }));
      if (newHealth <= 0) {
        setIsDebating(false);
        setCurrentSceneId('bad_end_debate');
      }
    }
  };

  // æ ¹æ“šåº«å­˜ç¯©é¸é¸é …
  const getFilteredOptions = () => {
    if (currentScene.type !== 'hub') {
        return currentScene.options;
    }

    // ç¯©é¸æ‰å·²ç¶“æ”¶é›†åˆ°çš„è­‰ç‰©é¸é …
    return currentScene.options.filter(opt => {
        if (opt.style === 'action') {
            return true; // æ”¤ç‰Œé¸é …æ°¸é ä¿ç•™
        }
        if (opt.condition) {
            const requiredItem = opt.condition.replace('!', '');
            // å¦‚æœ condition æ˜¯ '!item_id' ä¸” item_id ä¸åœ¨ inventory ä¸­ï¼Œå‰‡é¡¯ç¤ºé¸é …
            if (opt.condition.startsWith('!')) {
                return !inventory.includes(requiredItem);
            }
        }
        return true;
    });
  };

  const restartGame = () => {
    setStats(INITIAL_STATS);
    setInventory([]);
    setCurrentSceneId('start');
    setIsDebating(false);
    setDebateRound(0);
  };

  const handleOpenDetail = (itemId) => {
    setDetailItem(itemId);
    setIsDetailOpen(true);
  };


  return (
    <div className="min-h-screen bg-black text-gray-100 font-sans flex flex-col items-center justify-center p-4 md:p-6">

      {/* çŸ¥è­˜å•ç­”æ¨¡æ…‹ */}
      {isQuizOpen && currentQuizItem && (
        <QuizModal
            itemId={currentQuizItem}
            onQuizComplete={handleQuizComplete}
            stats={stats}
            setStats={setStats}
        />
      )}

      {/* è­‰ç‰©è©³æƒ…æ¨¡æ…‹ */}
      {isDetailOpen && detailItem && (
        <EvidenceDetailModal
            itemId={detailItem}
            onClose={() => setIsDetailOpen(false)}
        />
      )}


      <div className="w-full max-w-4xl bg-slate-900 pixel-box border border-slate-700 shadow-pixel-dark overflow-hidden flex flex-col md:flex-row h-[90vh] md:h-[80vh]">

        {/* å·¦å´ï¼šéŠæˆ²å€å¡Š */}
        <div className={`flex-1 relative flex flex-col ${isDebating ? 'bg-slate-900' : currentScene.bg} transition-colors duration-500`}>

          {!isDebating && (
            <div className="absolute top-0 left-0 w-full p-4 bg-gradient-to-b from-black/80 to-transparent z-10 flex justify-between items-start pointer-events-none">
               <div className="flex items-center gap-2 text-blue-300 font-bold text-lg pixel-text-shadow">
                 <span className='text-2xl'>ğŸ‘»</span> è¿·éœ§æ´¾å°ï¼šåæ¯’æ–‡å­—å†’éšª
               </div>
            </div>
          )}

          <div ref={scrollRef} className="flex-1 overflow-y-auto p-6 md:p-10 flex flex-col relative">

            {/* è¾¯è«–ä»‹é¢ */}
            {isDebating && (
              <DebateInterface
                currentRoundIndex={debateRound}
                hp={stats.health}
                evidenceList={inventory}
                onPresent={handleDebateResult}
                // å‚³é setStats è®“äº‚è¿½å•æ™‚å¯ä»¥æ‰£ç†æ™º
                setStats={setStats}
              />
            )}

            {/* æ™®é€šå ´æ™¯ä»‹é¢ */}
            {!isDebating && (
                <div className="max-w-2xl mx-auto w-full mt-8 animate-fade-in-up">
                    <div className="mb-2 text-yellow-500 font-bold tracking-widest text-sm uppercase pixel-text-shadow">Current Scene</div>
                    <h2 className="text-4xl md:text-5xl font-bold mb-8 text-white tracking-tight leading-tight pixel-text-shadow">
                        {currentScene.title}
                    </h2>
                    <div className="prose prose-invert prose-lg text-gray-200 leading-loose whitespace-pre-wrap bg-black/50 p-6 pixel-box-small border-l-4 border-blue-500">
                        {currentScene.text}
                    </div>

                    {/* çµå±€ç•«é¢ */}
                    {currentScene.type === 'win' && (
                        <div className="mt-8 p-6 bg-green-900/40 border border-green-500 pixel-box-small text-center animate-bounce">
                            <span className="text-6xl mx-auto text-green-400 mb-2">ğŸ›¡ï¸</span>
                            <div className="text-2xl font-bold text-green-300 pixel-text-shadow">CASE CLOSED</div>
                            <div className="text-green-400">æˆåŠŸä¿è­·è‡ªå·±èˆ‡æœ‹å‹</div>
                        </div>
                    )}
                    {(currentScene.type === 'lose' || currentScene.type === 'neutral') && (
                        <div className="mt-8 p-6 bg-red-900/40 border border-red-500 pixel-box-small text-center">
                            <span className="text-6xl mx-auto text-red-400 mb-2">âŒ</span>
                            <div className="text-2xl font-bold text-red-300 pixel-text-shadow">æŒ‘æˆ°å¤±æ•—</div>
                            {currentScene.id === 'bad_end_run' && <div className="text-red-400">å› èº«å¿ƒå´©æ½°æˆ–è­‰æ“šä¸è¶³è€Œå¤±æ•—</div>}
                        </div>
                    )}
                </div>
            )}
          </div>

          {/* åº•éƒ¨é¸é …å€ */}
          {!isDebating && (
            <div className="bg-slate-950 p-6 border-t border-slate-800">
               {(currentScene.type === 'win' || currentScene.type === 'lose' || currentScene.type === 'neutral') ? (
                  <button
                    onClick={restartGame}
                    className="pixel-button w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-lg flex items-center justify-center gap-2 transition-transform"
                  >
                    <span className='text-xl'>ğŸšª</span> é‡æ–°æŒ‘æˆ° / é‡å•ŸéŠæˆ²
                  </button>
               ) : (
                 <div className="grid grid-cols-1 gap-3 max-w-2xl mx-auto">
                   {getFilteredOptions().map((option, index) => (
                     <button
                       key={index}
                       onClick={() => handleOptionClick(option)}
                       className={`pixel-button-option p-4 text-left border transition-all flex items-center justify-between group ${
                         option.style === 'action'
                           ? "bg-red-600 hover:bg-red-700 border-red-500 text-white font-bold shadow-lg shadow-red-900/20"
                           : "bg-slate-800 hover:bg-slate-700 border-slate-600 hover:border-blue-400 text-blue-100"
                       }`}
                     >
                       <span className="flex items-center gap-3">
                         <span className={`flex items-center justify-center w-8 h-8 text-sm font-bold border ${option.style === 'action' ? 'bg-white text-red-600 border-red-600' : 'bg-slate-700 text-blue-300 border-slate-600'}`}>
                           {index + 1}
                         </span>
                         {option.text}
                       </span>
                       {option.style !== 'action' && <span className="w-5 h-5 opacity-0 group-hover:opacity-100 transition-opacity text-blue-400 text-xl">ğŸ”</span>}
                       {option.style === 'action' && <span className="w-5 h-5 text-white text-xl">ğŸ”¨</span>}
                     </button>
                   ))}
                 </div>
               )}
            </div>
          )}
        </div>
        
        {/* å³å´ï¼šåº«å­˜èˆ‡ç‹€æ…‹å€ */}
        <div className="md:w-64 bg-slate-800 p-6 border-l border-slate-700 flex flex-col">
            <h3 className="text-xl font-black text-yellow-400 mb-4 flex items-center gap-2 border-b border-slate-700 pb-2 pixel-text-shadow">
                <span className='text-2xl'>ğŸ“’</span> åº«å­˜èˆ‡ç‹€æ…‹
            </h3>
            
            {/* ç‹€æ…‹é¡¯ç¤º */}
            <div className="space-y-3 mb-6">
                <div className="flex justify-between items-center text-sm font-bold p-2 pixel-box-small-no-shadow border-l-4 border-green-500 bg-slate-700">
                    <div className="flex items-center gap-2 text-green-400">
                        <span className='text-xl'>â¤ï¸</span> ä¿¡å¿ƒ/å¥åº·
                    </div>
                    <span className="font-mono text-lg text-green-300">{stats.health}%</span>
                </div>
                <div className="flex justify-between items-center text-sm font-bold p-2 pixel-box-small-no-shadow border-l-4 border-blue-500 bg-slate-700">
                    <div className="flex items-center gap-2 text-blue-400">
                        <span className='text-xl'>ğŸ§ </span> ç†æ™º/å†·éœ
                    </div>
                    <span className="font-mono text-lg text-blue-300">{stats.sanity}%</span>
                </div>
            </div>

            {/* è­‰ç‰©åº«å­˜ */}
            <h4 className="text-lg font-bold text-gray-200 mb-3 flex items-center gap-2">
                <span className='text-2xl'>ğŸ”¨</span> å·²æ”¶é›†è­‰ç‰© ({inventory.length}/4)
            </h4>
            <div className="flex flex-col gap-3 overflow-y-auto flex-1">
                {inventory.length === 0 ? (
                    <p className="text-sm text-gray-400 italic">
                        ä½ é‚„æ²’æœ‰æ”¶é›†åˆ°ä»»ä½•é—œéµè­‰æ“šã€‚
                    </p>
                ) : (
                    inventory.map(itemId => (
                        <EvidenceCard key={itemId} itemId={itemId} onClick={handleOpenDetail} />
                    ))
                )}
            </div>
        </div>

      </div>

      <style>{`
        /* å¼•å…¥åƒç´ é¢¨æ ¼å­—é«” */
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        /* å…¨å±€å­—é«”å’ŒåŸºæœ¬æ¨£å¼ */
        .font-sans, .pixel-box, .pixel-button, .pixel-button-small, .pixel-button-option {
            font-family: 'Press Start 2P', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
        }
        
        /* ç§»é™¤ Tailwind çš„åœ“è§’, å¯¦ç¾åƒç´ åŒ– */
        .pixel-box, .pixel-button, .pixel-button-small, .pixel-button-option {
            border-radius: 0 !important;
        }

        /* åƒç´ é¢¨æ ¼å®¹å™¨ */
        .pixel-box {
            box-shadow: 8px 8px 0px 0px #1a202c !important; /* æ¨¡æ“¬é™°å½±åç§» */
        }
        .shadow-pixel-dark {
            box-shadow: 10px 10px 0px 0px #0f172a !important; 
        }
        .shadow-pixel-blue {
            box-shadow: 8px 8px 0px 0px #3b82f6 !important; /* è—è‰²é™°å½± */
        }
        .shadow-pixel-yellow {
             box-shadow: 4px 4px 0px 0px #f59e0b !important;
        }

        .pixel-box-small {
             border-radius: 0 !important;
             box-shadow: 4px 4px 0px 0px #0f172a !important; 
        }
        .pixel-box-small-no-shadow {
             border-radius: 0 !important;
             box-shadow: none; 
        }

        /* åƒç´ é¢¨æ ¼æŒ‰éˆ•åŸºåº• */
        .pixel-button {
            border: 2px solid white;
            box-shadow: 4px 4px 0px 0px #374151; /* é™°å½± */
            transition: all 0.05s ease-out;
        }
        .pixel-button:hover {
            box-shadow: 6px 6px 0px 0px #374151;
            transform: translate(-2px, -2px); /* è¼•å¾®æŠ¬å‡ */
        }
        .pixel-button:active {
            box-shadow: 0px 0px 0px 0px #374151;
            transform: translate(4px, 4px); /* æŒ‰ä¸‹æ•ˆæœ */
        }
        .pixel-button:disabled {
            box-shadow: none !important;
            transform: none !important;
        }

        .pixel-button-option {
            border: 1px solid #475569;
            transition: all 0.1s ease-out;
        }
        .pixel-button-option:hover {
            border: 1px solid #60a5fa;
        }

        /* å°èˆªæŒ‰éˆ•æ¨£å¼ */
        .pixel-button-nav {
            border: 2px solid white;
            box-shadow: 2px 2px 0px 0px #000;
        }
        .pixel-button-nav:hover {
            box-shadow: 3px 3px 0px 0px #000;
            transform: translate(-1px, -1px);
        }
        .pixel-button-nav:active {
            box-shadow: 0px 0px 0px 0px #000;
            transform: translate(2px, 2px);
        }


        .pixel-text-shadow {
            text-shadow: 2px 2px 0 #000; /* æ¨¡æ“¬ç²—é«”å’Œåƒç´ æ„Ÿ */
        }


        /* å‹•ç•« */
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fade-in-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes zoom-in { 0% { opacity: 0; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes shake {
          0%, 100% { transform: translateX(0); }
          25% { transform: translateX(-5px); }
          75% { transform: translateX(5px); }
        }
        /* New: Slow Pulse */
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .animate-pulse-slow { animation: pulse-slow 3s infinite; }

        .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
        .animate-fade-in-up { animation: fade-in-up 0.5s ease-out forwards; }
        .animate-zoom-in { animation: zoom-in 0.3s ease-out forwards; }
        .animate-shake { animation: shake 0.3s ease-in-out; }
      `}</style>
    </div>
  );
};

export default App;